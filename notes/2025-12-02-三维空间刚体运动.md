# 三维空间刚体运动

---
## 概述

1. 刚体的概念：内部任意两点间距离保持不变。
2. 刚体的自由度：在三维空间中有6个自由度：3个平移，3个旋转。
3. 描述刚体运动：
   - 位置：用坐标系原点在参考坐标系中的坐标表示。
   - 姿态：刚体坐标系相对于参考坐标系的旋转。
4. 旋转的表示：
   - 旋转矩阵：3x3正交矩阵，行列式为1。属于SO(3)群。
   - 欧拉角：绕特定轴顺序的三次旋转（如 $$roll-pitch-yaw, ZYX$$ 等）。存在万向锁问题。
   - 轴角表示：旋转轴和旋转角度。
   - 四元数：单位四元数表示旋转，紧凑且无奇异性。
5. 变换矩阵：将旋转和平移结合成4x4齐次变换矩阵，属于SE(3)群。
6. 刚体运动的描述：给出一组点在两个坐标系中的坐标变换关系。

---

### 坐标系定义

我们默认使用 右手坐标系 -> 三维笛卡尔坐标系：

   - 拇指 -> x
   - 食指 -> y
   - 中指 -> z

三维空间中，每个向量本质是一个几何对象，而它的具体数字表示依赖于我们选择的 **基** 。

例如选择坐标系中每个坐标轴的单位向量作为**基向量**。

定义坐标以后，向量就可以由 $\mathbb{R}^3$ 坐标表示。

---

### 那么什么是   $\mathbb{R}^3$ ?

$\mathbb{R}^3$ 就是所有三元实数向量的集合： $\mathbb{R}^3 = \{(x,y,z)\mid x,y,z\in\mathbb{R}\}$  ，我们可以把它想象成三维空间中所有箭头的代数表示。

在三维空间里，我们选一个上述的右手笛卡尔坐标系：

   - $x$ 轴 -> $\mathbf{e}_1 = (1,0,0)^T$

   - $y$ 轴 -> $\mathbf{e}_2 = (0,1,0)^T$

   - $z$ 轴 -> $\mathbf{e}_3 = (0,0,1)^T$

保证 $\mathbf{e}_1,\mathbf{e}_2,\mathbf{e}_3$ 的方向是右手系 $\mathbf{e}_1 \times \mathbf{e}_2 = \mathbf{e}_3$ ，这三条轴对应的单位向量 $\mathbf{e}_1,\mathbf{e}_2,\mathbf{e}_3$ 构成了 $\mathbb{R}^3$  的一组基。

在这个基底下，任何一个几何向量 ($\vec{v}$) 都可以写成： $\vec{v} = x\mathbf{e}_1 + y\mathbf{e}_2 + z\mathbf{e}_3$

于是，我们用它在这组基下的坐标来表示：

$$
\vec{v} \longleftrightarrow \begin{bmatrix} x \\ y \\ z \end{bmatrix} \in \mathbb{R}^3
$$

或用矩阵乘法形式表示为：

$$
\mathbf{v} = [\mathbf{e}_1, \mathbf{e}_2, \mathbf{e}_3] \begin{bmatrix} x \\ y \\ z \end{bmatrix} = x\mathbf{e}_1 + y\mathbf{e}_2 + z\mathbf{e}_3
$$



在向量构成的线性空间中允许向量加减、标量乘法、**内积（dot product）、外积（cross product）**

向量加减以及数乘都比较简单，不做讨论。

---

### 那么什么是向量的**外积**和**内积**呢？

#### 外积 ($\mathbb{R}^3 \times \mathbb{R}^3 \to \mathbb{R}^3$)

向量外积也叫叉积也称为叉乘，记作为：

$$
a \times b
$$

向量外积代数公式：

$$
a \times b =
\begin{bmatrix}
a_y b_z - a_z b_y \\
a_z b_x - a_x b_z \\
a_x b_y - a_y b_x
\end{bmatrix}
$$

**更重要的其实是它的几何意义：**

外积的结果是一个**新的向量**（仅在三维空间中定义），它衡量了两个向量所张成的面积，并指明了旋转方向

**外积 = 垂直于两向量的方向 × 它们围成的平行四边形面积**

既然外积的结果必然是一个向量，那么我们只需要关注这个向量的大小与方向即可

外积的大小可以形象的理解为**两个向量所围成的面积**，也就是两向量**模长**   

$$
|a \times b| = |a|,|b| \sin\theta
$$

由公式可以看出 若两向量平行 -> 面积为0 -> 外积为0；若两向量垂直 -> 面积最大 -> 外积最大。

外积的方向与两向量所构成的**平面垂直**，根据右手定则确定

外积其几何意义体现在**方向**与**长度**上面，即如上所述向量所张成的**面积**和**垂直方向**

#### 内积 ($\mathbb{R}^3 \times \mathbb{R}^3 \to \mathbb{R}$)

内积，也叫做点乘，说到底是用来衡量两个向量**指向是否一致**的程度，也就是我们通常所说的两个向量之间计算**投影**。

**内积 = 向量长度 × 另一向量在它方向上的投影**

将两个向量输入，通过计算两个向量模长与夹角，然后得到一个**标量**，记作：

$$
a \cdot b = |a|, |b| \cos\theta
$$

从公式不难看出：内积越大，两个向量越平行；内积为 0，两个向量正交；内积为负，两个向量相反方向。

这很好的衡量了两个向量方向的一致性

#### 外积与内积的关系

从几何上来说，外积与内积是一种互补关系：外积关注于垂直程度；内积关注于平行程度。从数值大小上来说两者一个变大另一个必然变小，此消彼长。

下面如果我们忽略方向，只看大小，内积和外积满足一个非常漂亮的**勾股定理**形式的关系，[拉格朗日恒等式](https://zh.wikipedia.org/wiki/%E6%8B%89%E6%A0%BC%E6%9C%97%E6%97%A5%E6%81%92%E7%AD%89%E5%BC%8F)：

$$
|\mathbf{a} \times \mathbf{b}|^2 + (\mathbf{a} \cdot \mathbf{b})^2 = (|\mathbf{a}| |\mathbf{b}|)^2
$$


这其实也就是三角函数恒等式 $\sin^2\theta + \cos^2\theta = 1$ 的向量表达：

$$
\underbrace{(|\mathbf{a}||\mathbf{b}|\sin\theta)^2}_{\text{外积模平方}} + \underbrace{(|\mathbf{a}||\mathbf{b}|\cos\theta)^2}_{\text{内积平方}} = (|\mathbf{a}||\mathbf{b}|)^2 (\sin^2\theta + \cos^2\theta) = (|\mathbf{a}||\mathbf{b}|)^2
$$

从公式里面可以看出，无论两个向量夹角如何变化，它们**平行的分量**和**垂直的分量**的平方和，总是等于它们长度乘积的平方。

更通俗的来讲也就是 **外积负责正弦，内积负责余弦，两者共同组成完整的角度信息** ，这也与之前所说的互补关系相互印证。

所以我们可以认为 **内积 + 外积 = 两个向量所有几何信息的完整分解** 。

当然，如果从几何代数的角度来说它们本质上是一个完整几何关系的两个部分，如下：

$$
ab = \mathbf{a} \cdot \mathbf{b} + \mathbf{a} \wedge \mathbf{b}
$$

其中  $\mathbf{a} \wedge \mathbf{b}$ 是[楔积](https://zh.wikipedia.org/zh-hans/%E5%A4%96%E7%A7%AF)，结果是一个，它代表了由 $\mathbf{a}$ 和 $\mathbf{b}$ 张成的**有向平面单元**， $\wedge$ 符号在数学上更具**普遍性**，可以推广到任意维度，而 $\times$ 符号只存在于三维和七维空间。最终的结果是标量与双向量的和，称为[多向量](https://en.wikipedia.org/wiki/Multivector)，是一种简洁、优雅、统一的表达方式。

​	若感兴趣，详细参考 [几何积](https://zh.wikipedia.org/wiki/%E5%87%A0%E4%BD%95%E4%BB%A3%E6%95%B0) 以及 [混合积](https://zh.wikipedia.org/wiki/%E6%B7%B7%E5%90%88%E7%A7%AF) 。

---

### 三维空间视角下的内积与外积

1、内积 = 向量投影 = 对齐程度

​	有了内积我们可以轻松求出两个向量方向的一致程度，甚至与两平面或多平面之间的角度关系

​	如果你对大语言模型方面有所了解的话，你一定知道 LLM 的每个词、token、句子都会被表示成一个向量， embedding 在高维空间中，就是通过**内积**来判断这些高维向量的相似度，因为语言的语义关系在高维 embedding 空间中也表现为“方向是否相似”，内积恰好自然反映这种关系，这将用于注意力、词向量相似度、下一个词预测等核心机制，是 LLM 的根本计算方式之一。

2、外积 = 垂直方向 = 面积 = 旋转轴（通俗表示，便于理解，并不严谨）

​	外积是 三维空间存在的特殊结构， 二维空间没有叉积，三维因为自由度多一个，所以叉积恰好存在。		

​	它在SLAM中可以用来求出相机旋转轴，这是 SO(3) 优化的基础；还有可以方便的求出法向量以及 IMU 解算中的陀螺仪积分。

---

## *坐标系之间如何变化？*

## *如何计算同一个向量在不同坐标系里的坐标？*

### 刚体运动 = 旋转 + 平移

在三维空间中，任意复杂的刚体运动都可以分解为先进行一次**旋转（改变姿态）**，再进行一次**平移（改变位置）**。

如果一个点在坐标系 A 中的坐标为 $p$，在坐标系 B 中的坐标为 $p'$，两者关系为：

$$
p' = R p + t
$$

其中： $R \in SO(3)$ ：**旋转矩阵**， $t \in \mathbb{R}^3$ ：**平移向量**

### 旋转矩阵

旋转矩阵 $R$ 是一类非常特殊的 $3\times3$ 矩阵： $$R^TR = I,\quad \det(R)=+1$$ ，它是一个线性变换，可以使所有向量的长度和夹角都不变。

满足这两个条件的矩阵构成**特殊正交群**：

$$
SO(3) = \{ R \in \mathbb{R}^{3\times3} \mid R^T R = I,\ \det(R) = 1 \}
$$

### 变换矩阵

刚体运动由旋转与平移两个部分组成： $$T = (R, t)$$

使用**齐次坐标**后，可以写成一个 $4\times4$ 矩阵：

$$
T = \begin{bmatrix} R & t \\ 0\ 0\ 0 & 1 \end{bmatrix}
$$

**其作用：**

$$
\begin{bmatrix} a' \\ 1 \end{bmatrix} = T \begin{bmatrix} a \\ 1 \end{bmatrix}
$$

所有刚体变换矩阵  $T$  构成： $SE(3)$ ，称为**特殊欧氏群**：

$$
SE(3) =
\{\, T = 
\begin{bmatrix}
R & \mathbf{t} \\
\mathbf{0}^T & 1
\end{bmatrix}
\in \mathbb{R}^{4\times4} \mid R \in SO(3),\ \mathbf{t} \in \mathbb{R}^3 \,\}
$$

### 反向变换

如果： $$a' = Ra + t$$   想求  $a$ ： $$a = R^T (a' - t)$$

因此刚体变换的逆为：

$$
T^{-1} =
\begin{bmatrix}
R^T & -R^T t \\
0 & 0 & 0 & 1
\end{bmatrix}
$$



因为不难看出这是一个正交矩阵，所以旋转矩阵的逆就是它的转置。

### 从 SO(3) 到 SE(3)

这里初步讨论SO(3) 与 SE(3)，方便理解上面关于旋转矩阵以及变换矩阵，后面再专门来讨论 **[Lie 代数中的群](https://zh.wikipedia.org/wiki/%E7%BE%A4)** (这是极其重要的)

#### 什么是 SO(3)？

SO(3) 全名为 **S**pecial **O**rthogonal Group in **3**D  翻译过来就是 *三维特殊正交群*

它是一堆 $3 \times 3$ 矩阵的集合。这些矩阵都有一个共同特点：

$$
R \in \mathbb{R}^{3\times 3},\quad R^T R = I,\quad \det(R) = 1
$$

**$R^T R = I$** 意味着列向量两两 **正交**、且都是单位向量。从几何意义上来说，它不改变向量长度、不改变向量间的夹角。所以它是**刚体意义上的纯旋转**。

$\det(R)=1$  排除掉镜像翻转（行列式为 -1 的情况），保证是“正”的旋转，维护右手坐标系。也就是说完全不允许发生镜像变换，因为在真实三维世界中不存在把左手转成右手，左脚转成右脚这类只有镜像变换才会发生的情况。       

​	SO(3) = 所有三维空间中的“纯旋转”动作的集合 + 一套合理的运算规则。

#### 我们需要一个简洁的运算表示

前面我们讨论过，三维空间中一个刚体从 A 姿态到 B 姿态，需要进行旋转和平移即可达到目的；当然如果只到旋转不需要平移那么 SO(3)已经足够了 $$\mathbf{p}' = R \mathbf{p}$$ ，但是在真实世界中机器人绝大多数情况都是 旋转+平移， $$\mathbf{p}' = R \mathbf{p} + \mathbf{t}$$ ，我们前面已经讨论过了，如果一次变换那就是  $$\mathbf{p}' = R \mathbf{p} + \mathbf{t}$$​  就可以解决，虽然公式简单，但在连续做多次变换时，如  $R_2(R_1 p + t_1) + t_2$ ，这时公式会变得极其丑陋且难以维护。

这是我们就希望有一个统一的数学对象，像 SO(3) 那样优雅，同时包含旋转 ($R$)、平移 ($t$)，还能**多次连续变换，同时方便求出反向变换**。

这也就是 **SE(3) —— Special Euclidean Group in 3D** 翻译过来就是 *三维特殊欧式群* ，下面将展示引入该概念后多次连续变换的简洁性。

同时为了把加法 $Rp + t$ 变成矩阵乘法，我们需要引入 $4 \times 4$ 矩阵：

$$
T = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^T & 1 \end{bmatrix}
$$

对一个点（使用齐次坐标 $\tilde{\mathbf{p}} = [\mathbf{p}, 1]^T$ ）：

$$
\tilde{\mathbf{p}}' = T \tilde{\mathbf{p}} = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^T & 1 \end{bmatrix} \begin{bmatrix} \mathbf{p} \\ 1 \end{bmatrix} = \begin{bmatrix} R\mathbf{p} + \mathbf{t} \\ 1 \end{bmatrix}
$$

矩阵中那个 1 的唯一作用，是为了在矩阵乘法中把 $\mathbf{t}$ 给带出来（ $R \cdot p + t \cdot 1$ ），实现用乘法表示加法。

现在我们再来讨论串联多个刚体变换的数学表达，这一步也算是理解 SLAM 坐标系变换的关键。

设有一个空间点，在坐标系 A 中的坐标是 $\mathbf{p}_A$ ，它的齐次坐标记为：

$$
\tilde{\mathbf{p}}_A = \begin{bmatrix} \mathbf{p}_A \\ 1 \end{bmatrix}
$$

设有两个刚体变换  $T_1$  和  $T_2$ ：

$$
T_1 = \begin{bmatrix} R_1 & \mathbf{t}_1 \\ 0 & 1 \end{bmatrix}, \quad T_2 = \begin{bmatrix} R_2 & \mathbf{t}_2 \\ 0 & 1 \end{bmatrix}
$$

其中 $T_2$ 把点从坐标系 A 变到 坐标系 B， $T_1$ 再从 坐标系 B 变到 坐标系 C

现在需要将 $\mathbf{p}_A$ 从坐标系 A 变换到 坐标系 C 中表示，

那么 $$\tilde{\mathbf{p}}_B = T_2 \tilde{\mathbf{p}}_A,\quad \tilde{\mathbf{p}}_C = T_1 \tilde{\mathbf{p}}_B = T_1 (T_2 \tilde{\mathbf{p}}_A)$$ 也就是 $$\tilde{\mathbf{p}}_C = (T_1 T_2) \tilde{\mathbf{p}}_A$$ ，也就是：

$$
T_1 T_2 = \begin{bmatrix} R_1 & \mathbf{t}_1 \\ \mathbf{0} & 1 \end{bmatrix} \begin{bmatrix} R_2 & \mathbf{t}_2 \\ \mathbf{0} & 1 \end{bmatrix} = \begin{bmatrix} R_1 R_2 & R_1 \mathbf{t}_2 + \mathbf{t}_1 \\ \mathbf{0} & 1 \end{bmatrix}
$$

$$
\tilde{\mathbf{p}}_C = T_1 T_2 \tilde{\mathbf{p}}_A = \begin{bmatrix} R_1 R_2 & R_1\mathbf{t}_2 + \mathbf{t}_1 \\ \mathbf{0} & 1 \end{bmatrix} \begin{bmatrix} \mathbf{p}_A \\ 1 \end{bmatrix} = \begin{bmatrix} R_1 R_2 \mathbf{p}_A + R_1 \mathbf{t}_2 + \mathbf{t}_1 \\ 1 \end{bmatrix}
$$

从计算结果中可以清楚看到 总平移为 $R_1 \mathbf{t}_2 + \mathbf{t}_1$ ，但是我还是想强调一下，一定严格计算，不可主观臆断，平移不可写成简单的 $\mathbf{t}_1 + \mathbf{t}_2$ ，因为 $\mathbf{t}_2$ 是在“中间坐标系 B”下的平移在合并到 $T_1$ 之前，要先被 $R_1$ **旋转**到 C 的参考方向上，也就是 $R_1 \mathbf{t}_2$ ，然后再加上 $T_1$ 自己的平移 $\mathbf{t}_1$。

从上面的矩阵中可以看出，如果我们需要多次连续变换只需要多个变换矩阵连续相乘即可，不再需要 $R_2(R_1 p + t_1) + t_2$ 这样的嵌套表达，做矩阵乘法对计算机来说也是更加高效的。

另外，这对于我们去求反向位姿也是极其方便的。

假设我们已知某个变换：

$$
T = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0} & 1 \end{bmatrix},\quad \tilde{\mathbf{p}}' = T \tilde{\mathbf{p}}
$$

我们希望从 $\tilde{\mathbf{p}}'$ 反推回 $\tilde{\mathbf{p}}$。

这时只需要求出 $T$ 的逆矩阵即可：

$$
T^{-1} = \begin{bmatrix} R^T & -R^T \mathbf{t} \\ \mathbf{0} & 1 \end{bmatrix}
$$

于是

$$
\tilde{\mathbf{p}} = T^{-1} \tilde{\mathbf{p}}'
$$

使用 Eigen 去求解将会是是十分便捷的操作。

到这里，应该对 从 SO(3) 和 SE(3) 的概念和作用有了一个初步了解，我们知道了 从 SO(3) 高效的表示了我们需要的**旋转**，SE(3) 不仅包含 SO(3) (旋转)，还包含了我们需要的平移，他们让我们得以统一优雅的表示刚体在三维空间中复杂的运动，是我们后续学习的基础。

当然，关于 Lie群 我们会在后面专门详细讨论，这会是一个有趣的话题。这里暂时不讨论 指数映射、旋转微分、运动旋量这些更加深入的概念，值得我们后面专门进行深入讨论。

---
















