# 三维空间刚体运动

---
## 概述

1. 刚体的概念：内部任意两点间距离保持不变。
2. 刚体的自由度：在三维空间中有6个自由度：3个平移，3个旋转。
3. 描述刚体运动：
   - 位置：用坐标系原点在参考坐标系中的坐标表示。
   - 姿态：刚体坐标系相对于参考坐标系的旋转。
4. 旋转的表示：
   - 旋转矩阵：3x3正交矩阵，行列式为1。属于SO(3)群。
   - 欧拉角：绕特定轴顺序的三次旋转（如roll-pitch-yaw, ZYX等）。存在万向锁问题。
   - 轴角表示：旋转轴和旋转角度。
   - 四元数：单位四元数表示旋转，紧凑且无奇异性。
5. 变换矩阵：将旋转和平移结合成4x4齐次变换矩阵，属于SE(3)群。
6. 刚体运动的描述：给出一组点在两个坐标系中的坐标变换关系。

---
### 坐标系定义

我们默认使用 右手坐标系 -> 三维笛卡尔坐标系：

   - 拇指 -> x
   - 食指 -> y
   - 中指 -> z

三维空间中，每个向量本质是一个几何对象，而它的具体数字表示依赖于我们选择的 **基** 。例如选择坐标系中每个坐标轴的单位向量作为 **基向量**。

定义坐标以后，向量就可以由 $\mathbb{R}^3$ 坐标表示。

---

### 那么什么是   $\mathbb{R}^3$ ?

$\mathbb{R}^3$ 就是所有三元实数向量的集合： $\mathbb{R}^3 = \{(x,y,z)\mid x,y,z\in\mathbb{R}\}$ ，我们可以把它想象成三维空间中所有箭头的代数表示。

在三维空间里，我们选一个上述的右手笛卡尔坐标系：

   - $x$ 轴 -> $\mathbf{e}_1 = (1,0,0)^T$

   - $y$ 轴 -> $\mathbf{e}_2 = (0,1,0)^T$

   - $z$ 轴 -> $\mathbf{e}_3 = (0,0,1)^T$

保证 $\mathbf{e}_1,\mathbf{e}_2,\mathbf{e}_3$ 的方向是右手系（ $\mathbf{e}_1 \times \mathbf{e}_2 = \mathbf{e}_3$ ），这三条轴对应的单位向量 $\mathbf{e}_1,\mathbf{e}_2,\mathbf{e}_3$ 构成了 $\mathbb{R}^3$  的一组基。

在这个基底下，任何一个几何向量 ( $\vec{v}$ ) 都可以写成： $\vec{v} = x\mathbf{e}_1 + y\mathbf{e}_2 + z\mathbf{e}_3$

于是，我们用它在这组基下的坐标来表示：

```math
\vec{v} \longleftrightarrow
\begin{bmatrix}
x \\
y \\
z
\end{bmatrix}
\in \mathbb{R}^3
```

或用矩阵乘法形式表示为：

```math
\mathbf{v} =
\begin{bmatrix}
\mathbf{e}_1 & \mathbf{e}_2 & \mathbf{e}_3
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
z
\end{bmatrix}
= x\mathbf{e}_1 + y\mathbf{e}_2 + z\mathbf{e}_3
```



在向量构成的线性空间中允许向量加减、标量乘法、**内积（dot product）、外积（cross product）**

向量加减以及数乘都比较简单，不做讨论。



---

### 那么什么是向量的**外积**和**内积**呢？

#### 外积 ( $\mathbb{R}^3 \times \mathbb{R}^3 \to \mathbb{R}^3$ )

向量外积也叫叉积也称为叉乘，记作为：

```math
a \times b
```

向量外积代数公式：

```math
a \times b =
\begin{bmatrix}
a_y b_z - a_z b_y \\
a_z b_x - a_x b_z \\
a_x b_y - a_y b_x
\end{bmatrix}
```

**更重要的其实是它的几何意义：**

外积的结果是一个**新的向量**（仅在三维空间中定义），它衡量了两个向量所张成的面积，并指明了旋转方向

**外积 = 垂直于两向量的方向 × 它们围成的平行四边形面积**

既然外积的结果必然是一个向量，那么我们只需要关注这个向量的大小与方向即可

外积的大小可以形象的理解为**两个向量所围成的面积**，也就是两向量**模长**   

```math
|a \times b| = |a|\,|b| \sin\theta
```

由公式可以看出 若两向量平行 -> 面积为0 -> 外积为0；若两向量垂直 -> 面积最大 -> 外积最大。

外积的方向与两向量所构成的**平面垂直**，根据右手定则确定

外积其几何意义体现在**方向**与**长度**上面，即如上所述向量所张成的**面积**和**垂直方向**

#### 内积 ( $\mathbb{R}^3 \times \mathbb{R}^3 \to \mathbb{R}$ )

内积，也叫做点乘，说到底是用来衡量两个向量**“指向是否一致”**的程度，也就是我们通常所说的两个向量之间计算**投影**。

**内积 = 向量长度 × 另一向量在它方向上的投影**

将两个向量输入，通过计算两个向量模长与夹角，然后得到一个**标量**，记作：

```math
a \cdot b = |a|\,|b| \cos\theta
```

从公式不难看出：内积越大，两个向量越平行；内积为 0，两个向量正交；内积为负，两个向量相反方向。

这很好的衡量了两个向量方向的一致性

#### 外积与内积的关系

从几何上来说，外积与内积是一种互补关系：外积关注于垂直程度；内积关注于平行程度。从数值大小上来说两者一个变大另一个必然变小，此消彼长。

下面如果我们忽略方向，只看大小，内积和外积满足一个非常漂亮的**勾股定理**形式的关系，[拉格朗日恒等式](https://zh.wikipedia.org/wiki/%E6%8B%89%E6%A0%BC%E6%9C%97%E6%97%A5%E6%81%92%E7%AD%89%E5%BC%8F)：

```math
|\mathbf{a} \times \mathbf{b}|^2 + (\mathbf{a} \cdot \mathbf{b})^2 = (|\mathbf{a}| |\mathbf{b}|)^2
```


这其实也就是三角函数恒等式 $\sin^2\theta + \cos^2\theta = 1$ 的向量表达：

```math
\underbrace{(|\mathbf{a}||\mathbf{b}|\sin\theta)^2}_{\text{外积模平方}} + \underbrace{(|\mathbf{a}||\mathbf{b}|\cos\theta)^2}_{\text{内积平方}} = (|\mathbf{a}||\mathbf{b}|)^2 (\sin^2\theta + \cos^2\theta) = (|\mathbf{a}||\mathbf{b}|)^2
```

从公式里面可以看出，无论两个向量夹角如何变化，它们**平行的分量**和**垂直的分量**的平方和，总是等于它们长度乘积的平方。

更通俗的来讲也就是 **外积负责正弦，内积负责余弦，两者共同组成完整的角度信息** ，这也与之前所说的互补关系相互印证。

所以我们可以认为 **内积 + 外积 = 两个向量所有几何信息的完整分解** 。

当然，如果从几何代数的角度来说它们本质上是一个完整几何关系的两个部分，如下：

```math
ab = \mathbf{a} \cdot \mathbf{b} + \mathbf{a} \wedge \mathbf{b}
```

其中  $\mathbf{a} \wedge \mathbf{b}$ 是 **[楔积](https://zh.wikipedia.org/zh-hans/%E5%A4%96%E7%A7%AF)** ，结果是一个，它代表了由 $\mathbf{a}$ 和 $\mathbf{b}$ 张成的**有向平面单元**， $\wedge$ 符号在数学上更具**普遍性**，可以推广到任意维度，而 $\times$ 符号只存在于三维和七维空间。最终的结果是标量与双向量的和，称为[多向量](https://en.wikipedia.org/wiki/Multivector)，是一种简洁、优雅、统一的表达方式。

​	若感兴趣，详细参考 [几何积](https://zh.wikipedia.org/wiki/%E5%87%A0%E4%BD%95%E4%BB%A3%E6%95%B0) 以及 [混合积](https://zh.wikipedia.org/wiki/%E6%B7%B7%E5%90%88%E7%A7%AF) 。

---

### 三维空间视角下的内积与外积

1、内积 = 向量投影 = 对齐程度

​	有了内积我们可以轻松求出两个向量方向的一致程度，甚至与两平面或多平面之间的角度关系

​	如果你对大语言模型方面有所了解的话，你一定知道 LLM 的每个词、token、句子都会被表示成一个向量， embedding 在高维空间中，就是通过**内积**来判断这些高维向量的相似度，因为语言的语义关系在高维 embedding 空间中也表现为“方向是否相似”，内积恰好自然反映这种关系，这将用于注意力、词向量相似度、下一个词预测等核心机制，是 LLM 的根本计算方式之一。

2、外积 = 垂直方向 = 面积 = 旋转轴（通俗表示，便于理解，并不严谨）

​	严格地说，2D 中仍然可以通过  $a_x b_y - a_y b_x$  得到有向面积，但结果是标量而不是向量；只有在 3D 和 7D 里，才能把这个面积元素重新解释成一个向量，因此才有通常意义上的向量叉积。		

​	它在SLAM中可以用来求出相机旋转轴，这是 SO(3) 优化的基础；还有可以方便的求出法向量以及 IMU 解算中的陀螺仪积分。


---
## *坐标系之间如何变化？*

## *如何计算同一个向量在不同坐标系里的坐标？*

### 刚体运动 = 旋转 + 平移

在三维空间中，任意复杂的刚体运动都可以分解为先进行一次**旋转（改变姿态）**，再进行一次**平移（改变位置）**。

如果一个点在坐标系 A 中的坐标为 $p$ ，在坐标系 B 中的坐标为 $p'$ ，两者关系为：

```math
p' = R p + t
```

其中： $R \in SO(3)$ ：**旋转矩阵**， $t \in \mathbb{R}^3$ ：**平移向量**

### 旋转矩阵

旋转矩阵 $R$ 是一类非常特殊的 $3\times 3$ 矩阵：

```math
R^\top R = I,\quad \det(R) = 1
```

它是一个线性变换，可以使所有向量的长度和夹角都不变。

满足这两个条件的矩阵构成**特殊正交群**：

```math
SO(3) = \left\{\, R \in \mathbb{R}^{3\times 3} \,\middle|\, R^\top R = I,\ \det(R) = 1 \,\right\}
```

### 变换矩阵

刚体运动由旋转与平移两个部分组成：

```math
T = (R, t)
```

使用**齐次坐标**后，可以写成一个 $4\times 4$ 矩阵：

```math
T = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix}
```

**其作用：**

```math
\begin{bmatrix} a' \\ 1 \end{bmatrix} = T \begin{bmatrix} a \\ 1 \end{bmatrix}
```

所有刚体变换矩阵  $T$  构成： $SE(3)$ ，称为**特殊欧氏群**：

```math
SE(3) = \left\{\, T = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix} \in \mathbb{R}^{4\times 4} \,\middle|\, R \in SO(3),\ \mathbf{t} \in \mathbb{R}^3 \,\right\}
```

### 反向变换

如果：

```math
a' = R a + t
```

想求 $a$ ：

```math
a = R^\top (a' - t)
```

因此刚体变换的逆为：

```math
T^{-1} = \begin{bmatrix} R^\top & -R^\top \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix}
```

因为不难看出这是一个正交矩阵，所以旋转矩阵的逆就是它的转置。

### 从 SO(3) 到 SE(3)

这里初步讨论SO(3) 与 SE(3)，方便理解上面关于旋转矩阵以及变换矩阵，后面再专门来讨论 **[Lie 代数中的群](https://zh.wikipedia.org/wiki/%E7%BE%A4)** (这是极其重要的)

#### 什么是 SO(3)？

SO(3) 全名为 **S**pecial **O**rthogonal Group in **3**D  翻译过来就是 *三维特殊正交群*

它是一堆 $3 \times 3$ 矩阵的集合。这些矩阵都有一个共同特点：

```math
R \in \mathbb{R}^{3\times 3},\quad R^\top R = I,\quad \det(R) = 1
```

**$R^T R = I$** 意味着列向量两两**正交**、且都是单位向量。从几何意义上来说，它不改变向量长度、不改变向量间的夹角。所以它是**刚体意义上的纯旋转**。

$\det(R)=1$ 排除掉镜像翻转（行列式为 -1 的情况），保证是“正”的旋转，维护右手坐标系。也就是说完全不允许发生镜像变换，因为在真实三维世界中不存在把左手转成右手，左脚转成右脚这类只有镜像变换才会发生的情况。       

​	SO(3) = 所有三维空间中的“纯旋转”动作的集合 + 一套合理的运算规则。

#### 我们需要一个简洁的运算表示

前面我们讨论过，三维空间中一个刚体从 A 姿态到 B 姿态，需要进行旋转和平移即可达到目的；当然如果只到旋转不需要平移那么 SO(3)已经足够了

```math
\mathbf{p}' = R \mathbf{p}
```

但是在真实世界中机器人绝大多数情况都是 旋转+平移，

```math
\mathbf{p}' = R \mathbf{p} + \mathbf{t}
```

我们前面已经讨论过了，如果一次变换那就是

```math
\mathbf{p}' = R \mathbf{p} + \mathbf{t}
```

​ 就可以解决，虽然公式简单，但在连续做多次变换时，如 $R_2(R_1 p + t_1) + t_2$ ，这时公式会变得极其丑陋且难以维护。

这是我们就希望有一个统一的数学对象，像 SO(3) 那样优雅，同时包含旋转 ( $R$ )、平移 ( $t$ )，还能**多次连续变换，同时方便求出反向变换**。

这也就是 **SE(3) —— Special Euclidean Group in 3D** 翻译过来就是 *三维特殊欧式群* ，下面将展示引入该概念后多次连续变换的简洁性。

同时，为了把加法 $R p + t$ 变成矩阵乘法，我们需要引入 $4 \times 4$ 矩阵：

```math
T = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix}
```

对一个点（使用齐次坐标  $\tilde{\mathbf{p}} = [\mathbf{p}, 1]^\top$  ）：

```math
\tilde{\mathbf{p}}'
= T \tilde{\mathbf{p}}
= \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix}
  \begin{bmatrix} \mathbf{p} \\ 1 \end{bmatrix}
= \begin{bmatrix} R \mathbf{p} + \mathbf{t} \\ 1 \end{bmatrix}
```

矩阵中那个 1 的唯一作用，是为了在矩阵乘法中把 $\mathbf{t}$ 给带出来（ $R \cdot p + t \cdot 1$ ），实现用乘法表示加法。



现在我们再来讨论串联多个刚体变换的数学表达，这一步也算是理解 SLAM 坐标系变换的关键。

设有一个空间点，在坐标系 A 中的坐标是 $\mathbf{p}_A$，它的齐次坐标记为：

```math
\tilde{\mathbf{p}}_A = \begin{bmatrix} \mathbf{p}_A \\ 1 \end{bmatrix}
```

设有两个刚体变换 $T_1$ 和 $T_2$：

```math
T_1 = \begin{bmatrix} R_1 & \mathbf{t}_1 \\ \mathbf{0}^\top & 1 \end{bmatrix}, \quad
T_2 = \begin{bmatrix} R_2 & \mathbf{t}_2 \\ \mathbf{0}^\top & 1 \end{bmatrix}
```

其中 $T_2$ 把点从坐标系 A 变到 坐标系 B， $T_1$ 再从 坐标系 B 变到 坐标系 C

现在需要将 $\mathbf{p}_A$ 从坐标系 A 变换到 坐标系 C 中表示，

那么

```math
\tilde{\mathbf{p}}_B = T_2 \tilde{\mathbf{p}}_A,\quad
\tilde{\mathbf{p}}_C = T_1 \tilde{\mathbf{p}}_B = T_1 (T_2 \tilde{\mathbf{p}}_A)
```

也就是

```math
\tilde{\mathbf{p}}_C = (T_1 T_2)\tilde{\mathbf{p}}_A
```

，也就是：

```math
T_1 T_2
= \begin{bmatrix} R_1 & \mathbf{t}_1 \\ \mathbf{0}^\top & 1 \end{bmatrix}
  \begin{bmatrix} R_2 & \mathbf{t}_2 \\ \mathbf{0}^\top & 1 \end{bmatrix}
= \begin{bmatrix} R_1 R_2 & R_1 \mathbf{t}_2 + \mathbf{t}_1 \\ \mathbf{0}^\top & 1 \end{bmatrix}
```

```math
\tilde{\mathbf{p}}_C
= T_1 T_2 \tilde{\mathbf{p}}_A
= \begin{bmatrix} R_1 R_2 & R_1\mathbf{t}_2 + \mathbf{t}_1 \\ \mathbf{0}^\top & 1 \end{bmatrix}
  \begin{bmatrix} \mathbf{p}_A \\ 1 \end{bmatrix}
= \begin{bmatrix} R_1 R_2 \mathbf{p}_A + R_1 \mathbf{t}_2 + \mathbf{t}_1 \\ 1 \end{bmatrix}
```

从计算结果中可以清楚看到 总平移为 $R_1 \mathbf{t}_2 + \mathbf{t}_1$ ，但是我还是想强调一下：一定严格计算，不可主观臆断，平移不可写成简单的 $\mathbf{t}_1 + \mathbf{t}_2$ ，因为 $\mathbf{t}_2$ 是在“中间坐标系 B”下的平移在合并到 $T_1$ 之前，要先被 $R_1$ **旋转**到 C 的参考方向上，也就是 $R_1 \mathbf{t}_2$ ，然后再加上 $T_1$ 自己的平移 $\mathbf{t}_1$。

从上面的矩阵中可以看出，如果我们需要多次连续变换只需要**多个变换矩阵连续相乘**即可，不再需要 $R_2(R_1 p + t_1) + t_2$ 这样的嵌套表达，做矩阵乘法对计算机来说也是更加高效的。

另外，这对于我们去求反向位姿也是极其方便的。

假设我们已知某个变换：

```math
T = \begin{bmatrix} R & \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix},\quad
\tilde{\mathbf{p}}' = T \tilde{\mathbf{p}}
```

我们希望从 $\tilde{\mathbf{p}}'$ 反推回 $\tilde{\mathbf{p}}$。

这时只需要求出 $T$ 的逆矩阵即可：

```math
T^{-1} = \begin{bmatrix} R^\top & -R^\top \mathbf{t} \\ \mathbf{0}^\top & 1 \end{bmatrix}
```

于是

```math
\tilde{\mathbf{p}} = T^{-1} \tilde{\mathbf{p}}'
```

使用 Eigen 去求解将会是是十分便捷的操作。

到这里为止，应该对 从 SO(3) 和 SE(3) 的概念和作用有了一个初步了解，我们知道了 从 SO(3) 高效的表示了我们需要的**旋转**，SE(3) 不仅包含 SO(3) (旋转)，还包含了我们需要的平移，他们让我们得以统一、优雅的表示刚体在三维空间中复杂的运动，是我们后续学习的基础。

当然，关于 *Lie群* 我们会在后面专门详细讨论，这会是一个有趣的话题。这里暂时不讨论 指数映射、旋转微分、运动旋量这些更加深入的概念，值得我们后面专门进行深入讨论。


---

### 旋转的多种表示方法

虽然旋转矩阵 $R \in SO(3)$ 数学性质严谨，适合理论推导，但它用 9 个参数来描述仅有 3 个自由度的旋转，这无疑具有很大的冗余性。

在实际工程应用中，我们通常会使用更紧凑、更直观的表示方法。

### 轴角 与 旋转向量

这是最直观的物理描述。根据欧拉旋转定理，刚体在三维空间中的任意旋转都可以等效为绕着通过原点的某个固定轴 $\mathbf{n}$ 旋转了一个角度 $\theta$。

**轴角表示**：由一个单位方向向量 $\mathbf{n} \in \mathbb{R}^3$ ($\|\mathbf{n}\|=1$) 和一个标量角度 $\theta$ 组成。

**旋转向量**：为了更紧凑，将轴和角合并为一个向量 $\boldsymbol{\omega} = \theta \mathbf{n}$。这个向量的方向表示旋转轴，模长表示旋转角。

与旋转矩阵的转换使用 [Rodrigues 公式](https://zh.wikipedia.org/wiki/%E7%BD%97%E5%BE%B7%E9%87%8C%E6%A0%BC%E6%97%8B%E8%BD%AC%E5%85%AC%E5%BC%8F)：

```math
R = I + \sin\theta\,\hat{\mathbf{n}} + (1-\cos\theta)\,\hat{\mathbf{n}}^2
```

其中 $\hat{\mathbf{n}}$ 是**反对称矩阵**：

```math
\hat{\mathbf{n}}= \begin{bmatrix} 0 & -n_z & n_y \\ n_z & 0 & -n_x \\ -n_y & n_x & 0 \end{bmatrix}
```


旋转向量与旋转矩阵之间可以通过罗德里格斯公式进行转换。用它旋转向量时，需要通过指数映射 (罗德里格斯公式) 先得到旋转矩阵 $R$，再作用到向量上。

(注：旋转向量在数学上对应于李代数 $\mathfrak{so}(3)$ 的元素，通过指数映射可到达 $SO(3)$，这是后续高级理论的基础，我们在后面再专门进行讨论。)

### 欧拉角 (Euler Angles)

欧拉角将旋转分解为绕三个坐标轴的连续旋转，非常符合人类的直观思维。在航空航天和机器人领域，常用的 ZYX 顺序对应于：

-  **偏航 (Yaw)**：绕 Z 轴旋转。
-  **俯仰 (Pitch)**：绕 Y 轴旋转（变换后的新 Y 轴）。
- **滚转 (Roll)**：绕 X 轴旋转（变换后的新 X 轴）。

```math
R_{total} = R_z(\text{yaw}) R_y(\text{pitch}) R_x(\text{roll})
```

但是，欧拉角最大的问题在于存在[万向锁 (Gimbal Lock)](https://en.wikipedia.org/wiki/Gimbal_lock)。

当中间的旋转轴（例如俯仰角 Pitch）旋转到 $\pm 90^\circ$ 时，第三次旋转的轴与第一次旋转的轴重合，导致系统瞬间失去了一个旋转自由度。

这会导致计算奇异性，因此在需要全方位旋转的 SLAM 和机器人控制中，应尽量避免在核心计算中使用欧拉角，通常仅用于人机交互界面的展示。

### 四元数 (Quaternion)

为了克服旋转矩阵的冗余性和欧拉角的万向锁问题，于是便引入了四元数。在现代机器人学中，因为四元数紧凑高效，所以**单位四元数是表示旋转的首选方案** 。

#### 定义

四元数是一种超复数，由一个实部 $w$ 和三个虚部 $(x, y, z)$ 组成，通常写成向量形式 $\mathbf{q} = [w, x, y, z]^T$。

用于表示旋转的必须是**单位四元数**，即模长为 1 ： $\|\mathbf{q}\|^2 = w^2 + x^2 + y^2 + z^2 = 1$ 。

#### 与轴角的关系

四元数与轴角 $(\theta, \mathbf{n})$ 有着直接的转换关系，理解这一点有助于建立对四元数的物理直观：

```math
\mathbf{q} = \begin{bmatrix} \cos(\frac{\theta}{2}) \\ n_x \sin(\frac{\theta}{2}) \\ n_y \sin(\frac{\theta}{2}) \\ n_z \sin(\frac{\theta}{2}) \end{bmatrix} = \begin{bmatrix} \cos(\frac{\theta}{2}) \\ \mathbf{n} \sin(\frac{\theta}{2}) \end{bmatrix}
```

(**注意**：这里的角度是 $\theta/2$ ，后面我们会讨论这个问题)

#### 如何用四元数旋转一个点？

这是实际应用中最关键的操作。

假设有一个三维向量 $\mathbf{v} = [x, y, z]^T$，我们想用表示旋转的单位四元数 $\mathbf{q}$ 对其进行旋转，得到新向量 $\mathbf{v}'$。

1. 将三维向量 $\mathbf{v}$ 扩展为一个实部为 0 的**虚四元数**： $\mathbf{p} = [0, x, y, z]^T$ 。
2. 执行以下的四元数乘法：

```math
\mathbf{p}' = \mathbf{q} \otimes \mathbf{p} \otimes \mathbf{q}^{-1}
```

对于单位四元数，其逆等于其共轭： $\mathbf{q}^{-1} = \mathbf{q}^* = [w, -x, -y, -z]^T$ 。

运算结果 $\mathbf{p}'$ 也是一个虚四元数，其虚部 $[x', y', z']^T$ 即为旋转后的向量 $\mathbf{v}'$。

*(注：在 Eigen 等常用 C++ 线性代数库中，为了方便，重载了乘法运算符，通常可以直接写成 `v_rotated = q * v`，其内部实现的就是上述的共轭操作乘积。)*

### 为什么四元数可以表示旋转？

实际上，上面这个过程就是把三维向量视作**虚四元数**嵌入到四维空间中，用四元数在四维空间里做一次旋转，再把结果虚部读出来，作为三维空间中旋转后的向量。**由于单位四元数的旋转保持虚四元数的结构**，所以结果仍然是纯虚的，其虚部刚好对应旋转后的三维向量。

因此，三维向量虽然在四维空间中参与运算，但最终仍然落回三维空间，通俗来说，这也是四元数能够优雅表示三维旋转的原因。

更加严格的来说：

三维向量在四维空间中做的其实是 **SO(3) 的嵌入旋转（[Spin 结构](https://en.wikipedia.org/wiki/Spin_structure)）**，这个映射天然保持它在虚空间中的结构。

四元数之所以能表示旋转，其实是因为 SO(3) 与 S³ 之间存在严格的数学对应关系。

我们知道 SO(3) 用来表达三维旋转群，目标是描述 3D 旋转；S³ 是四维单位球面，也就是单位四元数构成的集合。这其中重要的是 **单位四元数构成的集合 S³ 是 SO(3) 的双覆盖** ，也就是说每一个旋转矩阵 $R$ 其实都会对应**两个四元数** $q$ 和 $-q$ ，这一点从我们上述的计算中是可以看出来的，所以说 $\pm q$ 其实都表示相同的旋转。这就叫做 $\text{Spin}(3)$ 群覆盖 $SO(3)$，这是一个非常深刻的数学结构，由此我们可以知道并理解，**旋转本质上就藏在四元数里** 。

另外，值得一提的是，四元数虽然有 4 个参数：$[w, x, y, z]$ ，但**单位四元数**有约束，即 $w^2 + x^2 + y^2 + z^2 = 1$ ，因此也只有 **3 个自由度**。

并且它恰好编码了轴角表示：

```math
q = \bigl[\cos\frac{\theta}{2},\ \mathbf{n}\sin\frac{\theta}{2}\bigr]
```

所以方向（通过 $\mathbf{n}$）和角度（通过 $\theta/2$）都包含在四元数中了。这种操作可以有效解决轴角产生奇点并且不连续的情况，我们会专门讨论这个问题。

### 不同旋转表示之间的关系

前面我们已经详细讨论了刚体在三维空间中旋转的不同表示，旋转矩阵、四元数、欧拉角、轴角、旋转向量。

为什么描述旋转这么简单的动作，需要这么多复杂的数学工具？

其实它们都在描述同一个**物理现象（SO(3)）**，只是适用的场景不同，那么他们之间究竟存在什么样的联系？

下面以**轴角**为核心，对它们之间的关系展开探讨。

**轴角是旋转的最本质表达**，它更倾向于一种概念化的描述。三维空间中的任意刚体旋转，都可以等效为**绕着空间中通过原点的某个轴 $\mathbf{n}$，旋转了一个角度 $\theta$** ，都可以写成  $(R,\theta) \equiv (\mathbf{n}, \theta)$ ；旋转群 SO(3) 的李代数 $\mathfrak{so}(3)$ 就是轴角所在的空间，并且旋转向量是 $\mathfrak{so}(3)$ 的元素 $\theta \mathbf{u}$，这是旋转的本质。因为它正是 **Rodrigues’ Rotation Formula** 、**Lie 群**、**SO(3) 指数映射** 的基础，也是连接所有其他表示法的桥梁。

**旋转向量与轴角之间是压缩与解压的关系**，旋转向量 $\boldsymbol{\omega}$ 其实就是轴角的压缩版，也可以说旋转向量是轴角这一概念的向量化表达。为了省去写两个变量，我们把转角 $\theta$ 乘到了转轴 $\mathbf{n}$ 上，得到  $\boldsymbol{\omega} = \theta \cdot \mathbf{n}$ ，其中旋转向量的方向就是旋转轴，长度就是旋转角，直接把轴角写成了一个三维向量；旋转向量对应于 **李代数 $\mathfrak{so}(3)$** ，也就是旋转矩阵的*对数* 。

**四元数本质上是轴角的复指数表示** ，四元数  $\mathbf{q}$  引入了半角  $\theta/2$  ，表示为如下形式： 

```math
\mathbf{q} = \begin{bmatrix} \cos\frac{\theta}{2} \\ \mathbf{n} \cdot \sin\frac{\theta}{2} \end{bmatrix} = \cos\frac{\theta}{2} + (n_x i + n_y j + n_z k)\sin\frac{\theta}{2}
```

从公式中可以看出四元数的**实部** $w$ 存储了 $\cos(\theta/2)$ ，**虚部** $(x,y,z)$ 存储了轴 $\mathbf{n}$ 的方向信息，且被 $\sin(\theta/2)$ 缩放过 。上面在讨论轴角的本质时提到 "  旋转向量是 $\mathfrak{so}(3)$ 的元素 $\theta \mathbf{u}$ "，其实这里面存在一个问题，**在角度接近 $\pi$ 或 $-\pi$ 附近会出现奇点，不连续。** 比如绕 $+x$ 轴旋转 180° 与绕 $-x$ 轴旋转 -180°，描述上极其不稳定。但是四元数通过 **半角映射 （ $\theta/2$ ）** 把旋转映射到了更高维，让其变得连续。通过上面的公式也可以看出来，单位四元数把旋转放入了一个4D 单位球面（也就是我们前面说的($S^3$)），这样在 $S^3$ 上光滑，也就没有没有奇点和不连续产生。综上，我们也就可以看出四元数本质是轴角的平滑化、无奇点化、可微优化的表示，是轴角的一种平滑参数化。

同样这也可以回答为什么偏偏要 $\theta/2$ ？ 因为四元数是 4D 球面 S³ 的旋转，需要半角来保证群结构，通俗来讲也就是需要保证复合旋转正确性。

**旋转矩阵可以从轴角、旋转向量、四元数推导出来** 。

轴角 -> 旋转矩阵 : 通过 Rodrigues 公式

```math
R = I + \sin\theta [\mathbf{u}]_\times + (1 - \cos\theta)[\mathbf{u}]_\times^2 
```
其中 轴角表示为  $(\mathbf{u},\theta)$ 


旋转向量 -> 旋转矩阵 : $R = \exp([\boldsymbol{\phi}]_\times)$  ，其中 旋转向量表示为  $\boldsymbol{\phi} = \theta \mathbf{u}$  。可以看出 Rodrigues 公式本质上就是 $\mathfrak{so}(3)$ 的指数映射的封闭形式。

四元数 -> 旋转矩阵 ： 单位四元数 $q = (w,x,y,z)$ 对应如下 $3 \times 3$ 的正交矩阵

```math
R =
\begin{bmatrix}
1-2(y^2+z^2) & 2(xy - wz) & 2(xz + wy) \\
2(xy + wz) & 1-2(x^2+z^2) & 2(yz - wx) \\
2(xz - wy) & 2(yz + wx) & 1-2(x^2+y^2)
\end{bmatrix}
```

或者利用 $w^2 + x^2 + y^2 + z^2 = 1$ 的性质，对角线元素也可以写成这种形式，在数学上是等价的

```math
R = \begin{bmatrix}
w^2 + x^2 - y^2 - z^2 & 2(xy - zw) & 2(xz + yw) \\
2(xy + zw) & w^2 - x^2 + y^2 - z^2 & 2(yz - xw) \\
2(xz - yw) & 2(yz + xw) & w^2 - x^2 - y^2 + z^2
\end{bmatrix}
```

**欧拉角，孤独的局外人** 。欧拉角并不直接描述绕哪个轴转，而是把一个复杂的 3D 旋转，强行分解成**三次绕坐标轴的简单旋转** 。最常见的顺序是 **ZYX (Yaw-Pitch-Roll)**，这也是机器人领域惯用的标准。数学形式为三个旋转矩阵的连乘

```math
R = R_z(\psi) R_y(\theta) R_x(\phi)
```

轴角、旋转向量、四元数之间都能找到直接的几何对应，而欧拉角是人造概念，从欧拉角转换到旋转矩阵通常需要堆叠大量的三角函数，计算量大且容易出错，这导致欧拉角在数学性质上比较糟糕；除此以外像  万向锁、强顺序依赖、梯度不连续、插值抖动 都是十分头痛的问题，这也就决定欧拉角注定只适合人类直观描述与理解，不适合计算机进行大量运算使用。

---

## 总结

综上所述，我们已经系统地讨论了刚体在三维空间中的运动表示及其具体计算方法，从向量与坐标系的基础概念，到旋转与平移的统一表达，再到 SO(3) 与 SE(3) 的数学结构，以及多种旋转参数化方式之间的关系。作为 SLAM 领域的入门基础课，这些概念将贯穿整个 SLAM 体系，不仅构成理解三维几何的根基，也为后续的前端视觉模型、IMU 预积分、李群李代数优化等关键问题奠定了统一的数学框架。

在后续内容中，我们将进一步深入讨论 SO(3) 与 SE(3) 的性质，并系统引入更为重要的 Lie 群与 Lie 代数理论，讨论它们如何成为现代 SLAM 中处理位姿、增量更新、非线性优化的核心数学工具。


















